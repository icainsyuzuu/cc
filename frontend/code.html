<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoWaste Manager - Log Sampah Baru</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f9f0 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #2e7d32;
      font-size: 2.2em;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 1.1em;
    }

    .screens-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
    }

    .screen {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
      display: none;
      flex-direction: column;
      max-height: 700px;
    }

    .screen.active {
      display: flex;
    }

    .screen:hover {
      transform: translateY(-3px);
    }

    .screen-header {
      background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
      color: white;
      padding: 20px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      user-select: none;
    }

    .screen-content {
      padding: 25px;
      overflow-y: auto;
      flex-grow: 1;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
      font-size: 0.95em;
    }

    .form-input,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95em;
      transition: border-color 0.3s ease;
    }

    .form-input:focus,
    select:focus {
      outline: none;
      border-color: #4caf50;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .category-btn {
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      font-size: 0.9em;
      user-select: none;
    }

    .category-btn:hover {
      border-color: #4caf50;
      background: #f3f8f3;
    }

    .category-btn.selected {
      border-color: #4caf50;
      background: #e8f5e8;
      color: #2e7d32;
      font-weight: bold;
    }

    .upload-area {
      border: 2px dashed #4caf50;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      background: #f9fdf9;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 15px 0;
      user-select: none;
    }

    .upload-area:hover {
      background: #f0f8f0;
      border-color: #45a049;
    }

    .upload-icon {
      font-size: 3em;
      color: #4caf50;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: #4caf50;
      color: white;
      padding: 15px 25px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      width: 100%;
      margin: 10px 0;
      transition: background 0.3s ease;
      user-select: none;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #ff9800;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      margin: 5px 0;
      transition: background 0.3s ease;
      user-select: none;
      width: 48%;
    }

    .btn-secondary:hover {
      background: #f57c00;
    }

    .info-card {
      background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .success-card {
      background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
      border-left: 4px solid #4caf50;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }

    .points-display {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      margin: 15px 0;
    }

    .points-number {
      font-size: 2em;
      font-weight: bold;
      color: #f57c00;
    }

    .location-display {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .sensor-indicator {
      display: flex;
      align-items: center;
      background: #e8f5e8;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9em;
    }

    .sensor-dot {
      width: 12px;
      height: 12px;
      background: #4caf50;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .weight-slider {
      width: 100%;
      margin: 15px 0;
    }

    .weight-display {
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      color: #4caf50;
      margin: 10px 0;
    }

    .preview-image {
      width: 100%;
      height: 150px;
      background: #f0f0f0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      margin: 10px 0;
      user-select: none;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .history-item {
      background: #f9f9f9;
      border-left: 4px solid #4caf50;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }

    .tabs {
      display: flex;
      background: #f5f5f5;
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      background: transparent;
      user-select: none;
    }

    .tab.active {
      background: #4caf50;
      color: white;
      font-weight: bold;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .step {
      flex: 1;
      text-align: center;
      padding: 10px;
      position: relative;
      user-select: none;
    }

    .step.active {
      color: #4caf50;
      font-weight: bold;
    }

    .step.completed {
      color: #4caf50;
    }

    .step::after {
      content: '';
      position: absolute;
      top: 50%;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #e0e0e0;
      z-index: -1;
    }

    .step.completed::after {
      background: #4caf50;
    }

    .step:last-child::after {
      display: none;
    }

    /* Logs List */
    .logs-list {
      max-width: 1200px;
      margin: 30px auto 0;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 25px;
    }

    .log-item {
      border-left: 4px solid #4caf50;
      padding: 15px;
      margin-bottom: 16px;
      border-radius: 8px;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .log-details {
      flex-grow: 1;
      color: #333;
      font-size: 0.95em;
      line-height: 1.3;
    }

    .log-actions button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .log-actions button:hover {
      background: #388e3c;
    }
  </style>
</head>

<body>
  <div class="container" >
    <div class="header">
      <h1>‚ôªÔ∏è Log Sampah Baru</h1>
      <p>Catat sampah Anda dan dapatkan EcoPoints!</p>
    </div>

    <div class="screens-container">
      <!-- Step 1 -->
      <div class="screen active" data-step="1">
        <div class="screen-header">üìã Step 1: Pilih Kategori Sampah</div>
        <div class="screen-content">
          <div class="step-indicator">
            <div class="step active">1. Kategori</div>
            <div class="step">2. Detail</div>
            <div class="step">3. Lokasi</div>
            <div class="step">4. Konfirmasi</div>
          </div>
          <div class="form-group">
            <label class="form-label">üóÇÔ∏è Pilih Jenis Sampah:</label>
            <div class="category-grid" id="categoryGrid">
              <div class="category-btn selected" data-category="Plastik">
                <div style="font-size: 2em;">ü•§</div>
                <div><strong>Plastik</strong></div>
                <div style="font-size: 0.8em;">Botol, Kantong, Kemasan</div>
              </div>
              <div class="category-btn" data-category="Kertas">
                <div style="font-size: 2em;">üìÑ</div>
                <div><strong>Kertas</strong></div>
                <div style="font-size: 0.8em;">Koran, Karton, Buku</div>
              </div>
              <div class="category-btn" data-category="Logam">
                <div style="font-size: 2em;">ü•´</div>
                <div><strong>Logam</strong></div>
                <div style="font-size: 0.8em;">Kaleng, Aluminium</div>
              </div>
              <div class="category-btn" data-category="Organik">
                <div style="font-size: 2em;">üçå</div>
                <div><strong>Organik</strong></div>
                <div style="font-size: 0.8em;">Sisa Makanan, Daun</div>
              </div>
              <div class="category-btn" data-category="Elektronik">
                <div style="font-size: 2em;">üîã</div>
                <div><strong>Elektronik</strong></div>
                <div style="font-size: 0.8em;">Baterai, Gadget</div>
              </div>
              <div class="category-btn" data-category="B3">
                <div style="font-size: 2em;">üß™</div>
                <div><strong>B3 (Berbahaya)</strong></div>
                <div style="font-size: 0.8em;">Obat, Kimia</div>
              </div>
            </div>
          </div>
          <div class="info-card" id="infoCategory">
            <strong>‚ÑπÔ∏è Info Kategori Plastik:</strong><br />
            ‚Ä¢ Daur ulang: ‚úÖ Ya<br />
            ‚Ä¢ Harga jual: Rp 2.000-3.000/kg<br />
            ‚Ä¢ EcoPoints: 5 points/kg<br />
            ‚Ä¢ Tips: Cuci bersih sebelum buang
          </div>
          <button class="btn-primary" id="toStep2">‚û°Ô∏è Lanjut ke Detail</button>
          <button class="btn-secondary" id="backToDashboard">‚¨ÖÔ∏è Kembali</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="screen" data-step="2">
        <div class="screen-header">‚öñÔ∏è Step 2: Detail & Berat Sampah</div>
        <div class="screen-content">
          <div class="step-indicator">
            <div class="step completed">1. Kategori</div>
            <div class="step active">2. Detail</div>
            <div class="step">3. Lokasi</div>
            <div class="step">4. Konfirmasi</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="descInput">üìù Deskripsi Sampah:</label>
            <input type="text" id="descInput" class="form-input" placeholder="Contoh: Botol air mineral 600ml" />
          </div>
          <div class="form-group">
            <label class="form-label" for="weightInput">‚öñÔ∏è Berat Sampah (kg):</label>
            <input type="range" id="weightInput" class="weight-slider" min="0.1" max="10" step="0.1" value="1.5" />
            <div class="weight-display" id="weightDisplay">1.5 kg</div>
          </div>
          <div class="form-group">
            <label class="form-label">üì∏ Foto Sampah (Opsional):</label>
            <div class="upload-area" id="uploadArea">
              <div class="upload-icon">üì∑</div>
              <div><strong>Tap untuk ambil foto</strong></div>
              <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Atau pilih dari galeri
              </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display:none" />
            <div class="preview-image" id="previewImage">
              üñºÔ∏è Preview foto akan muncul di sini
            </div>
          </div>
          <div class="points-display">
            <div class="points-number" id="pointsNumber">+7</div>
            <div>EcoPoints yang akan didapat</div>
            <div style="font-size: 0.9em; margin-top: 5px;">üí∞ Estimasi nilai: Rp 3.000</div>
          </div>
          <button class="btn-primary" id="toStep3">üìç Tentukan Lokasi</button>
          <button class="btn-secondary" id="backToStep1">‚¨ÖÔ∏è Kembali</button>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="screen" data-step="3">
        <div class="screen-header">üìç Step 3: Lokasi & Pembuangan</div>
        <div class="screen-content">
          <div class="step-indicator">
            <div class="step completed">1. Kategori</div>
            <div class="step completed">2. Detail</div>
            <div class="step active">3. Lokasi</div>
            <div class="step">4. Konfirmasi</div>
          </div>
          <div class="form-group">
            <button class="btn-secondary" id="refreshLocation">üîÑ Refresh Lokasi</button>
          </div>
          <div class="form-group">
            <label class="form-label">üóëÔ∏è Pilih Metode Pembuangan:</label>
            <div class="tabs" id="disposalTabs">
              <button class="tab active" data-method="bank" disabled>üè¶ Bank Sampah</button>
              <button class="tab" data-method="rumah" disabled>üè† Di Rumah</button>
              <button class="tab" data-method="tps" disabled>üóëÔ∏è TPS Terdekat</button>
            </div>
            <div class="info-card" id="disposalInfo"></div>
          </div>
          <div class="form-group">
            <label class="form-label" for="scheduleSelect">‚è∞ Jadwal Pembuangan:</label>
            <select class="form-input" id="scheduleSelect">
              <option>Sekarang</option>
              <option>Besok pagi (07:00)</option>
              <option>Jadwal rutin (Senin & Kamis)</option>
              <option>Custom jadwal</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">üåç Konversi Waktu:</label>
            <div style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                font-size: 0.9em;
              ">
              <div style="
                  background: #f5f5f5;
                  padding: 8px;
                  border-radius: 5px;
                ">
                <strong>WIB:</strong> 14:30
              </div>
              <div style="
                  background: #f5f5f5;
                  padding: 8px;
                  border-radius: 5px;
                ">
                <strong>WITA:</strong> 15:30
              </div>
              <div style="
                  background: #f5f5f5;
                  padding: 8px;
                  border-radius: 5px;
                ">
                <strong>WIT:</strong> 16:30
              </div>
              <div style="
                  background: #f5f5f5;
                  padding: 8px;
                  border-radius: 5px;
                ">
                <strong>London:</strong> 08:30
              </div>
            </div>
          </div>
          <button class="btn-primary" id="toStep4">‚úÖ Konfirmasi Log</button>
          <button class="btn-secondary" id="backToStep2">‚¨ÖÔ∏è Kembali</button>
        </div>
      </div>

      <!-- Step 4 -->
      <div class="screen" data-step="4">
        <div class="screen-header">‚úÖ Step 4: Konfirmasi & Berhasil</div>
        <div class="screen-content">
          <div class="step-indicator">
            <div class="step completed">1. Kategori</div>
            <div class="step completed">2. Detail</div>
            <div class="step completed">3. Lokasi</div>
            <div class="step active">4. Konfirmasi</div>
          </div>
          <div class="success-card">
            <div style="font-size: 3em; margin-bottom: 10px;">üéâ</div>
            <h3 style="color: #2e7d32; margin-bottom: 10px;">Log Sampah Berhasil!</h3>
            <div>Terima kasih telah berkontribusi untuk lingkungan</div>
          </div>
          <div class="info-card" id="summaryLog">
            <strong>üìã Ringkasan Log Sampah:</strong><br />
            ‚Ä¢ Kategori: ü•§ Plastik<br />
            ‚Ä¢ Deskripsi: Botol plastik bekas minuman<br />
            ‚Ä¢ Berat: 1.5 kg<br />
            ‚Ä¢ Lokasi: Jl. Sudirman No. 123<br />
            ‚Ä¢ Waktu: 24 Mei 2025, 14:30 WIB<br />
            ‚Ä¢ Metode: üè† Di Rumah
          </div>
          <div class="points-display">
            <div class="points-number" id="finalPoints">+7</div>
            <div>EcoPoints Didapat!</div>
            <div style="font-size: 0.9em; margin-top: 5px;">
              üí∞ Estimasi nilai: Rp 3.000<br />
              üèÜ Total EcoPoints: 252
            </div>
          </div>
          <div class="info-card">
            <strong>üåç Environmental Impact:</strong><br />
            ‚Ä¢ CO2 Dikurangi: 0.8 kg<br />
            ‚Ä¢ Air Dihemat: 45 liter<br />
            ‚Ä¢ Energi Dihemat: 2.1 kWh
          </div>
          <div class="form-group">
            <label class="form-label">üîî Pengaturan Notifikasi:</label>
            <div style="display: flex; align-items: center; margin: 10px 0;">
              <input type="checkbox" checked style="margin-right: 8px;" />
              <label>Ingatkan saya untuk pengambilan sampah</label>
            </div>
            <div style="display: flex; align-items: center; margin: 10px 0;">
              <input type="checkbox" checked style="margin-right: 8px;" />
              <label>Notifikasi achievement baru</label>
            </div>
          </div>
          <button class="btn-primary" id="submitLog">üì§ Kirim Log</button>

          <button class="btn-primary" id="backHomeBtn">üè† Kembali ke Home</button>
          <button class="btn-secondary" id="logAnotherBtn">‚ûï Log Sampah Lain</button>
          <button class="btn-secondary" id="shareAchievementBtn">üì§ Bagikan Achievement</button>
        </div>
      </div>
    </div>

    <div class="logs-list" id="logsList" aria-label="Riwayat log sampah" tabindex="0" style="max-width:1200px;margin:40px auto;">

    </div>
  </div>

  <script type="module" src="config.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module">
    import { BASE_URL } from "./config.js";
    import { refreshAccessTokenIfNeeded } from "./auth.js";

    // Form state object tracking current data and mode
    const formState = {
      id: null, // null means create; ID present means update
      category: 'Plastik',
      description: 'Botol plastik bekas minuman',
      weight: 1.5,
      disposalMethod: 'bank',
      schedule: 'Sekarang',
      location: 'Jl. Sudirman No. 123, Jakarta Pusat',
      points: 5,
      calculatedPoints: 7,
      logDate: new Date().toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
      photoDataUrl: null,
    };

    function getWasteIdByCategory(category) {
      const map = {
        'Plastik': 1,
        'Kertas': 2,
        'Logam': 3,
        'Organik': 4,
        'Elektronik': 5,
        'B3': 6
      };
      return map[category] || 1;
    }

    function getLocationIdByName(locationName) {
      const map = {
        'Jl. Sudirman No. 123, Jakarta Pusat': 101,
        'Di Rumah': 102,
        'TPS Terdekat': 103,
        'Bank Sampah': 104,
      };
      return map[locationName] || 101;
    }

    // DOM elements
    const categoryGrid = document.getElementById('categoryGrid');
    const infoCategory = document.getElementById('infoCategory');
    const weightInput = document.getElementById('weightInput');
    const weightDisplay = document.getElementById('weightDisplay');
    const descInput = document.getElementById('descInput');
    const uploadArea = document.getElementById('uploadArea');
    const photoInput = document.getElementById('photoInput');
    const previewImage = document.getElementById('previewImage');
    const disposalTabs = document.getElementById('disposalTabs');
    const disposalInfo = document.getElementById('disposalInfo');
    const scheduleSelect = document.getElementById('scheduleSelect');
    const currentLocation = document.getElementById('currentLocation');

    const toStep2Btn = document.getElementById('toStep2');
    const toStep3Btn = document.getElementById('toStep3');
    const toStep4Btn = document.getElementById('toStep4');
    const backToStep1Btn = document.getElementById('backToStep1');
    const backToStep2Btn = document.getElementById('backToStep2');
    const backHomeBtn = document.getElementById('backHomeBtn');
    const logAnotherBtn = document.getElementById('logAnotherBtn');
    const shareAchievementBtn = document.getElementById('shareAchievementBtn');

    const submitLogBtn = document.getElementById('submitLog');

    const screens = document.querySelectorAll('.screen');
    const logsList = document.getElementById('logsList');
    const summaryLog = document.getElementById('summaryLog');
    const finalPoints = document.getElementById('finalPoints');

    // Update category info block and points
    function updateCategoryInfo(cat) {
      let infoText = '';
      let pointsForCategory = 0;
      switch (cat) {
        case 'Plastik':
          infoText = `‚ÑπÔ∏è Info Kategori Plastik:<br>‚Ä¢ Daur ulang: ‚úÖ Ya<br>‚Ä¢ Harga jual: Rp 2.000-3.000/kg<br>‚Ä¢ EcoPoints: 5 points/kg<br>‚Ä¢ Tips: Cuci bersih sebelum buang`;
          pointsForCategory = 5;
          break;
        case 'Kertas':
          infoText = `‚ÑπÔ∏è Info Kategori Kertas:<br>‚Ä¢ Daur ulang: ‚úÖ Ya<br>‚Ä¢ Harga jual: Rp 1.500-2.500/kg<br>‚Ä¢ EcoPoints: 4 points/kg<br>‚Ä¢ Tips: Pisahkan kertas bersih dan kotor`;
          pointsForCategory = 4;
          break;
        case 'Logam':
          infoText = `‚ÑπÔ∏è Info Kategori Logam:<br>‚Ä¢ Daur ulang: ‚úÖ Ya<br>‚Ä¢ Harga jual: Rp 3.000-4.000/kg<br>‚Ä¢ EcoPoints: 6 points/kg<br>‚Ä¢ Tips: Bersihkan sebelum dijual`;
          pointsForCategory = 6;
          break;
        case 'Organik':
          infoText = `‚ÑπÔ∏è Info Kategori Organik:<br>‚Ä¢ Daur ulang: ‚ùå Tidak<br>‚Ä¢ Harga jual: Rp 500-1.000/kg<br>‚Ä¢ EcoPoints: 2 points/kg<br>‚Ä¢ Tips: Komposkan sisa makanan`;
          pointsForCategory = 2;
          break;
        case 'Elektronik':
          infoText = `‚ÑπÔ∏è Info Kategori Elektronik:<br>‚Ä¢ Daur ulang: ‚úÖ Ya<br>‚Ä¢ Harga jual: Rp 10.000-20.000/kg<br>‚Ä¢ EcoPoints: 10 points/kg<br>‚Ä¢ Tips: Bawa ke pusat daur ulang khusus`;
          pointsForCategory = 10;
          break;
        case 'B3':
          infoText = `‚ÑπÔ∏è Info Kategori B3:<br>‚Ä¢ Daur ulang: ‚ùå Tidak<br>‚Ä¢ Harga jual: N/A<br>‚Ä¢ EcoPoints: 0 points/kg<br>‚Ä¢ Tips: Tangani dengan aman dan benar`;
          pointsForCategory = 0;
          break;
      }
      formState.category = cat;
      formState.points = pointsForCategory;
      infoCategory.innerHTML = infoText;
      updatePointsDisplay();
    }

    // Update points display based on weight and base points
    function updatePointsDisplay() {
      const totalPoints = Math.round(formState.points * formState.weight);
      document.getElementById('pointsNumber').textContent = `+${totalPoints}`;
      formState.calculatedPoints = totalPoints;
    }

    // Update disposal info text
    function updateDisposalInfo(method) {
      formState.disposalMethod = method;
      let text = '';
      switch (method) {
        case 'rumah':
          text = `<strong>üè† Pembuangan di Rumah</strong><br>‚Ä¢ Sampah akan dikategorikan dalam tempat sampah rumah<br>‚Ä¢ Menunggu jadwal pengambilan sampah<br>‚Ä¢ EcoPoints: Normal (${formState.points} points)`;
          break;
        case 'tps':
          text = `<strong>üóëÔ∏è TPS Terdekat</strong><br>‚Ä¢ Buang langsung ke TPS terdekat<br>‚Ä¢ EcoPoints: Bonus +2 points`;
          break;
        case 'bank':
          text = `<strong>üè¶ Bank Sampah</strong><br>‚Ä¢ Bawa ke bank sampah resmi<br>‚Ä¢ EcoPoints: Bonus +5 points`;
          break;
      }
      disposalInfo.innerHTML = text;
    }

    // Show step function
    function showStep(step) {
      screens.forEach(screen => {
        screen.classList.toggle('active', screen.getAttribute('data-step') == step);
      });
      updateStepIndicators(step);
      if (step == '4') {
        updateSummary();
      }
    }

    // Update navigation step indicators
    function updateStepIndicators(step) {
      screens.forEach(screen => {
        const steps = screen.querySelectorAll('.step');
        steps.forEach((st, i) => {
          if (i + 1 < step) {
            st.classList.add('completed');
            st.classList.remove('active');
          } else if (i + 1 == step) {
            st.classList.add('active');
            st.classList.remove('completed');
          } else {
            st.classList.remove('active', 'completed');
          }
        });
      });
    }

    // Fill form inputs from formState
    function populateFormFields() {
      // Category buttons
      [...categoryGrid.children].forEach(btn => {
        const cat = btn.getAttribute('data-category');
        const isSelected = cat === formState.category;
        btn.classList.toggle('selected', isSelected);
      });

      updateCategoryInfo(formState.category);

      // Description
      if (descInput) descInput.value = formState.description || '';

      // Weight slider
      if (weightInput) {
        weightInput.value = formState.weight || 1.5;
        weightDisplay.textContent = `${formState.weight.toFixed(1)} kg`;
      }

      // Disposal method tabs
      if (disposalTabs) {
        [...disposalTabs.children].forEach(tab => {
          const tabMethod = tab.getAttribute('data-method');
          const active = tabMethod === formState.disposalMethod;
          tab.classList.toggle('active', active);
        });
        updateDisposalInfo(formState.disposalMethod);
      }

      // Schedule select
      if (scheduleSelect) scheduleSelect.value = formState.schedule;

      // Location display (dummy static)
      if (currentLocation) {
        currentLocation.innerHTML = `üåç Menggunakan GPS...<br /><strong>${formState.location}</strong><br /><small>Akurasi: ¬±5 meter</small>`;
      }

      // Photo preview
      if (formState.photoDataUrl) {
        previewImage.style.backgroundImage = `url(${formState.photoDataUrl})`;
        previewImage.textContent = '';
      } else {
        previewImage.style.backgroundImage = '';
        previewImage.textContent = 'üñºÔ∏è Preview foto akan muncul di sini';
      }
    }

    // Reset form state to default for new create action
    function resetFormState() {
      formState.id = null;
      formState.category = 'Plastik';
      formState.description = 'Botol plastik bekas minuman';
      formState.weight = 1.5;
      formState.disposalMethod = 'bank';
      formState.schedule = 'Sekarang';
      formState.location = 'Jl. Sudirman No. 123, Jakarta Pusat';
      formState.points = 5;
      formState.calculatedPoints = 7;
      formState.logDate = new Date().toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      formState.photoDataUrl = null;
      photoInput.value = '';
    }

    // Update summary for step 4 based on formState
    function updateSummary() {
      const summary = `
      <strong>üìã Ringkasan Log Sampah:</strong><br />
      ‚Ä¢ Kategori: ${getCategoryEmoji(formState.category)} ${formState.category}<br />
      ‚Ä¢ Deskripsi: ${formState.description}<br />
      ‚Ä¢ Berat: ${formState.weight.toFixed(1)} kg<br />
      ‚Ä¢ Lokasi: ${formState.location}<br />
      ‚Ä¢ Waktu: ${formState.logDate}<br />
      ‚Ä¢ Metode: ${getDisposalEmoji(formState.disposalMethod)} ${getDisposalName(formState.disposalMethod)}
      `;
      summaryLog.innerHTML = summary;
      finalPoints.textContent = `+${formState.calculatedPoints || formState.points}`;
    }

    // Emoji helpers
    function getCategoryEmoji(cat) {
      switch (cat) {
        case 'Plastik': return 'ü•§';
        case 'Kertas': return 'üìÑ';
        case 'Logam': return 'ü•´';
        case 'Organik': return 'üçå';
        case 'Elektronik': return 'üîã';
        case 'B3': return 'üß™';
        default: return '';
      }
    }

    function getDisposalEmoji(method) {
      switch (method) {
        case 'rumah': return 'üè†';
        case 'tps': return 'üóëÔ∏è';
        case 'bank': return 'üè¶';
        default: return '';
      }
    }

    function getDisposalName(method) {
      switch (method) {
        case 'rumah': return 'Di Rumah';
        case 'tps': return 'TPS Terdekat';
        case 'bank': return 'Bank Sampah';
        default: return '';
      }
    }

    // Navigation buttons
    toStep2Btn.addEventListener('click', () => {
      showStep('2');
    });
    toStep3Btn.addEventListener('click', () => {
      formState.description = descInput.value.trim();
      if (!formState.description) {
        alert('Deskripsi sampah tidak boleh kosong');
        return;
      }
      showStep('3');
    });
    toStep4Btn.addEventListener('click', () => {
      showStep('4');
    });
    backToStep1Btn.addEventListener('click', () => showStep('1'));
    backToStep2Btn.addEventListener('click', () => showStep('2'));
    backHomeBtn.addEventListener('click', () => {
      window.location.href = 'dashboard.html';
    });
    logAnotherBtn.addEventListener('click', () => {
      resetFormState();
      populateFormFields();
      submitLogBtn.textContent = 'üì§ Kirim Log';
      showStep('1');
    });
    shareAchievementBtn.addEventListener('click', () => {
      alert('Fitur share belum tersedia');
    });
    document.getElementById('backToDashboard').addEventListener('click', () => {
      window.location.href = 'dashboard.html';
    });

    // Category select
    categoryGrid.addEventListener('click', e => {
      const target = e.target.closest('.category-btn');
      if (!target) return;
      [...categoryGrid.children].forEach(btn => btn.classList.remove('selected'));
      target.classList.add('selected');
      const cat = target.getAttribute('data-category');
      updateCategoryInfo(cat);
    });

    // Weight slider
    weightInput.addEventListener('input', e => {
      formState.weight = parseFloat(e.target.value);
      weightDisplay.textContent = `${formState.weight.toFixed(1)} kg`;
      updatePointsDisplay();
    });

    // Photo upload and preview
    uploadArea.addEventListener('click', () => photoInput.click());
    photoInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) {
        formState.photoDataUrl = null;
        previewImage.style.backgroundImage = '';
        previewImage.textContent = 'üñºÔ∏è Preview foto akan muncul di sini';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        formState.photoDataUrl = reader.result;
        previewImage.style.backgroundImage = `url(${reader.result})`;
        previewImage.textContent = '';
      };
      reader.readAsDataURL(file);
    });

    // Disposal method tabs
    disposalTabs.addEventListener('click', e => {
      const target = e.target.closest('.tab');
      if (!target) return;
      [...disposalTabs.children].forEach(tab => tab.classList.remove('active'));
      target.classList.add('active');
      const method = target.getAttribute('data-method');
      formState.disposalMethod = method;
      updateDisposalInfo(method);
    });

    // Schedule select
    scheduleSelect.addEventListener('change', e => {
      formState.schedule = e.target.value;
    });

    // Refresh location
    document.getElementById('refreshLocation').addEventListener('click', () => {
      currentLocation.innerHTML = `üåç Menggunakan GPS...<br /><strong>Jl. Sudirman No. 123, Jakarta Pusat</strong><br /><small>Akurasi: ¬±5 meter</small>`;
      formState.location = 'Jl. Sudirman No. 123, Jakarta Pusat';
      alert('Lokasi berhasil diperbarui!');
    });

    // Submit create or update waste log
    submitLogBtn.addEventListener('click', async () => {
      const userId = sessionStorage.getItem('userId');
      if (!userId) {
        alert('Anda harus login terlebih dahulu.');
        window.location.href = 'index.html';
        return;
      }

      formState.description = descInput.value.trim();
      if (!formState.category) {
        alert('Kategori harus dipilih.');
        return;
      }
      if (!formState.description) {
        alert('Deskripsi tidak boleh kosong.');
        showStep('2');
        return;
      }
      if (!formState.weight || formState.weight <= 0) {
        alert('Berat sampah harus lebih dari 0.');
        showStep('2');
        return;
      }

      try {
        const token = sessionStorage.getItem('accessToken');
        const formData = new FormData();
        formData.append("weight", formState.weight);
        formData.append("date_collected", new Date().toISOString());
        formData.append("waste_id", getWasteIdByCategory(formState.category));
        formData.append("location_id", getLocationIdByName(formState.location));
        formData.append("description", formState.description);
        formData.append("disposal_method", formState.disposalMethod);
        formData.append("schedule", formState.schedule);

        if (photoInput.files[0]) {
          formData.append("image", photoInput.files[0]);
        }

        let response;
        if (formState.id) {
          // Update existing record
          response = await fetch(`${BASE_URL}/waste-record/${formState.id}`, {
            method: 'PUT',
            headers: {
              Authorization: 'Bearer ' + token,
            },
            body: formData,
          });
        } else {
          // Create new record
          response = await fetch(`${BASE_URL}/waste-record/user/${userId}`, {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + token,
            },
            body: formData,
          });
        }

        if (!response.ok) throw new Error('Gagal mengirim data log sampah');

        alert(`Log sampah berhasil ${formState.id ? 'diperbarui' : 'dikirim'}`);
        resetFormState();
        populateFormFields();
        submitLogBtn.textContent = 'üì§ Kirim Log';
        showStep('1');
        await fetchWasteLogs(userId);
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    // Fetch user waste logs and display with edit buttons
    async function fetchWasteLogs(userId) {
      await refreshAccessTokenIfNeeded();
      try {
        const response = await fetch(`${BASE_URL}/waste-record/user/${userId}`, {
          headers: { Authorization: 'Bearer ' + sessionStorage.getItem('accessToken') }
        });
        if (!response.ok) throw new Error('Gagal mengambil data log');

        const result = await response.json();
        const logs = result.data;
        if (!logs || logs.length === 0) {
          logsList.innerHTML = "<p>Belum ada log sampah tersedia.</p>";
          return;
        }

        let html = '';
        logs.forEach(log => {
          const dateStr = new Date(log.date_collected).toLocaleDateString('id-ID');
          const points = Math.round(log.waste.eco_points * log.weight);
          const locationStr = `${log.location.name}, ${log.location.city}, ${log.location.province}`;
          html += `
            <div class="log-item" tabindex="0">
              <div class="log-details">
                <p><strong>${log.waste.type}</strong> (${points} pts) - ${dateStr}</p>
                <p>Berat: ${log.weight} kg</p>
                <p>Lokasi: ${locationStr}</p>
                ${log.image_url ? `<img src="${log.image_url}" alt="Foto Sampah" style="max-width: 100px; border-radius: 8px; margin-top: 8px;" />` : ''}
              </div>
              <div class="log-actions">
                <button data-id="${log.id}" aria-label="Edit log sampah ${log.id}">Edit</button>
              </div>
            </div>
          `;
        });
        logsList.innerHTML = html;

        // Add event listeners for edit buttons
        logsList.querySelectorAll('.log-actions button').forEach(button => {
          button.addEventListener('click', async () => {
            const id = button.getAttribute('data-id');
            await loadLogToEdit(id);
          });
        });
      } catch (error) {
        logsList.innerHTML = `<p style="color: red;">${error.message}</p>`;
      }
    }

    // Load existing log for editing
    // async function loadLogToEdit(logId) {
    //   await refreshAccessTokenIfNeeded();
    //   try {
    //     const response = await fetch(`${BASE_URL}/waste-record/${logId}`, {
    //       headers: {
    //         Authorization: 'Bearer ' + sessionStorage.getItem('accessToken'),
    //       }
    //     });
    //     if (!response.ok) throw new Error('Gagal memuat data log');

    //     const result = await response.json();
    //     const log = result.data;

    //     formState.id = log.id;
    //     formState.category = log.waste.type;
    //     formState.description = log.description || '';
    //     formState.weight = log.weight;
    //     formState.disposalMethod = 'bank'; // Default or retrieved if supported
    //     formState.schedule = 'Sekarang'; // Assume default, extend if API supports
    //     formState.location = `${log.location.name}, ${log.location.city}, ${log.location.province}`;
    //     formState.points = log.waste.eco_points;
    //     formState.calculatedPoints = Math.round(log.waste.eco_points * log.weight);
    //     formState.logDate = new Date(log.date_collected).toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    //     formState.photoDataUrl = log.image_url || null;
    //     if (photoInput) photoInput.value = '';

    //     populateFormFields();
    //     submitLogBtn.textContent = 'üíæ Perbarui Log';
    //     showStep('2');
    //   } catch (error) {
    //     alert('Error memuat data log untuk edit: ' + error.message);
    //   }
    // }

    // Initialize
    (async function init() {
      const userId = sessionStorage.getItem('userId');
      if (!userId) {
        alert('Anda harus login terlebih dahulu.');
        window.location.href = 'index.html';
        return;
      }
      resetFormState();
      populateFormFields();
      submitLogBtn.textContent = 'üì§ Kirim Log';
      updateCategoryInfo(formState.category);
      updateDisposalInfo(formState.disposalMethod);
      updatePointsDisplay();
      await fetchWasteLogs(userId);
      showStep('1');
    })();
    
  </script>
  <!-- Load loadNavbar.js untuk muat navbar
  <script src="assets/js/loadNavbar.js"></script> -->
</body>

</html>

